<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quiz App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; overscroll-behavior: none; -webkit-tap-highlight-color: transparent; }
        .action-button { transition: all 0.2s ease-in-out; }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.12); }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

    <div id="appContainer" class="w-full max-w-md mx-auto">
        <!-- MODAL SCREEN for User Login -->
        <div id="nameModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50">
            <div class="modal-content bg-white p-6 rounded-xl shadow-2xl text-center w-11/12">
                <h2 class="text-2xl font-bold mb-4 text-slate-800">Welcome!</h2>
                <div class="mb-4 text-sm text-slate-600 bg-slate-100 p-3 rounded-lg">
                    <strong>Earn 5 extra minutes</strong> of screen time for every quiz set you complete with >90%! Time resets weekly.
                </div>
                <p class="text-slate-600 mb-4">Please enter your name to start:</p>
                <input type="text" id="userNameInput" placeholder="Your Name" class="w-full p-3 border border-slate-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500 text-center text-lg">
                <button onclick="saveUserName()" class="action-button bg-blue-500 hover:bg-blue-600 text-white w-full py-3 px-6 rounded-lg text-lg font-semibold">Start Solving!</button>
            </div>
        </div>

        <!-- MAIN APPLICATION SCREENS (Initially hidden) -->
        <main id="mainContent" class="hidden">
            <!-- PERSISTENT HEADER -->
            <header id="persistentHeader" class="bg-white/80 backdrop-blur-sm p-4 rounded-xl shadow-lg mb-4">
                 <div class="flex justify-between items-center mb-2 text-sm">
                    <span class="font-semibold text-slate-700">This Week's Screen Time</span>
                    <span id="screenTimeText" class="font-bold text-blue-600">0 min</span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-4 border border-slate-300 overflow-hidden">
                    <div id="screenTimeBarFill" class="bg-gradient-to-r from-green-400 to-blue-500 h-full rounded-full text-white text-xs flex items-center justify-center transition-all duration-500" style="width: 0%"><span id="screenTimeBarText"></span></div>
                </div>
                <div id="screenTimeInfo" class="mt-2 text-xs text-slate-500 text-center"></div>
            </header>

            <!-- SET SELECTION SCREEN -->
            <div id="setSelectionScreen" class="bg-white p-6 md:p-8 rounded-xl shadow-lg text-center">
                <h1 class="text-2xl md:text-3xl font-bold text-slate-800 mb-2">Quiz Practice</h1>
                <p class="text-slate-600 mb-8">Choose a topic set to master!</p>
                <div id="setButtonsContainer" class="grid grid-cols-1 gap-4"><p id="loadingText" class="text-slate-500">Loading question sets...</p></div>
            </div>
            
            <!-- FLASHCARD GAME SCREEN -->
            <div id="flashcardScreen" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg"></div>

            <!-- RESULTS SCREEN -->
            <div id="resultsScreen" class="hidden bg-white p-6 md:p-8 rounded-xl shadow-lg text-center"></div>
        </main>
    </div>
    <canvas id="confettiCanvas" class="fixed inset-0 w-full h-full pointer-events-none z-[100]"></canvas>

<script>
// ===================================================================================
//  GLOBAL ERROR HANDLER
// ===================================================================================
window.onerror = function (message, source, lineno, colno, error) {
    alert(`A critical error occurred:\n\nMessage: ${message}\nSource: ${source}\nLine: ${lineno}`);
    return true; // Prevents the default browser error handling
};

// ===================================================================================
//  CONFIGURATION & CONSTANTS
// ===================================================================================
const CONFIG = {
    QUESTIONS_PER_SET: 15,
    AUTO_PROCEED_DELAY: 1200,
    USER_NAME_STORAGE_KEY: 'quizApp_v9',
    REWARD_THRESHOLD_PERCENT: 90,
    MINUTES_PER_REWARD: 5,
    APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxfKOXXssyg_9G_UKiR-hU6lyl0BoDGS6eiSPDFN2gaVbWHECK1Gweye8FHEDVhOCxHkA/exec'
};

// ===================================================================================
//  STATE MANAGEMENT
// ===================================================================================
const state = {
    allFlashcardSets: {},
    currentSetData: [],
    currentSetName: '',
    incorrectAnswers: [],
    score: 0,
    currentQuestionIndex: 0,
    startTime: null,
    isRedoing: false,
    userName: '',
    currentScreenTime: 0
};

// ===================================================================================
//  DOM ELEMENTS
// ===================================================================================
const DOM = {
    mainContent: document.getElementById('mainContent'),
    nameModal: document.getElementById('nameModal'),
    userNameInput: document.getElementById('userNameInput'),
    setSelectionScreen: document.getElementById('setSelectionScreen'),
    setButtonsContainer: document.getElementById('setButtonsContainer'),
    loadingText: document.getElementById('loadingText'),
    flashcardScreen: document.getElementById('flashcardScreen'),
    resultsScreen: document.getElementById('resultsScreen'),
    screenTimeText: document.getElementById('screenTimeText'),
    screenTimeBarFill: document.getElementById('screenTimeBarFill'),
    screenTimeBarText: document.getElementById('screenTimeBarText'),
    screenTimeInfo: document.getElementById('screenTimeInfo'),
    confetti: confetti.create(document.getElementById('confettiCanvas'), { resize: true, useWorker: true })
};

// ===================================================================================
//  SOUND EFFECTS
// ===================================================================================
const sounds = {
    correct: new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.2 }, }).toDestination(),
    incorrect: new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination()
};

// ===================================================================================
//  UTILITY & API FUNCTIONS
// ===================================================================================
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function sendDataToGoogle(payload) {
    fetch(CONFIG.APPS_SCRIPT_URL, {
        method: 'POST', mode: 'no-cors', cache: 'no-cache',
        headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    }).catch(err => console.error(`Error sending ${payload.payloadType}:`, err));
}

async function fetchFlashcardData() {
    DOM.loadingText.style.display = 'block';
    DOM.loadingText.textContent = 'Loading question sets...';
    try {
        const response = await fetch(CONFIG.APPS_SCRIPT_URL);
        const data = await response.json();
        if (data.status === 'error') throw new Error(data.message);
        state.allFlashcardSets = data;
        DOM.loadingText.style.display = 'none';
        populateSetButtons();
    } catch (error) {
        DOM.loadingText.textContent = 'Failed to load questions. Please refresh.';
        DOM.loadingText.style.color = 'red';
        console.error("Fetch Flashcard Error:", error);
    }
}

async function fetchScreenTime() {
    if (!state.userName) { updateScreenTimeUI(0); return; }
    try {
        const url = `${CONFIG.APPS_SCRIPT_URL}?action=getScreenTime&name=${encodeURIComponent(state.userName)}`;
        const response = await fetch(url);
        const data = await response.json();
        if (data.status === 'success') {
            state.currentScreenTime = data.minutes;
            updateScreenTimeUI(state.currentScreenTime);
        } else { throw new Error(data.message); }
    } catch (error) {
        updateScreenTimeUI(0);
        DOM.screenTimeText.textContent = 'Could not load time';
        console.error("Fetch Screen Time Error:", error);
    }
}

// ===================================================================================
//  UI & SCREEN RENDERERS
// ===================================================================================
function showScreen(screen) {
    [DOM.setSelectionScreen, DOM.flashcardScreen, DOM.resultsScreen].forEach(s => s.style.display = 'none');
    if (screen) screen.style.display = 'block';
}

function updateScreenTimeUI(minutes) {
    const goal = 30;
    const percentage = Math.min(100, (minutes / goal) * 100);
    DOM.screenTimeText.textContent = `${minutes} min earned`;
    DOM.screenTimeBarFill.style.width = `${percentage}%`;
    DOM.screenTimeBarText.textContent = minutes > 0 ? `${minutes} min` : '';
    const greeting = state.userName ? `Hi ${state.userName}, e` : 'E';
    DOM.screenTimeInfo.innerHTML = `<strong>${greeting}arn 5 extra minutes</strong> for every quiz set you pass with >90%! Time resets every Sunday.`;
}

function populateSetButtons() {
    DOM.setButtonsContainer.innerHTML = '';
    const sets = Object.keys(state.allFlashcardSets);
    if (sets.length === 0) {
        DOM.setButtonsContainer.innerHTML = '<p class="text-red-500">No question sets found in the database.</p>';
        return;
    }
    sets.forEach(setName => {
        const set = state.allFlashcardSets[setName];
        if (set && Array.isArray(set) && set.length > 0) {
            const button = document.createElement('button');
            button.textContent = `Start ${setName}`;
            button.className = 'action-button w-full py-3 px-6 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold';
            button.onclick = () => startFlashcardSession(set, setName);
            DOM.setButtonsContainer.appendChild(button);
        }
    });
}

// ===================================================================================
//  CORE APPLICATION LOGIC
// ===================================================================================
function init() {
    state.userName = localStorage.getItem(CONFIG.USER_NAME_STORAGE_KEY) || '';
    if (state.userName) {
        DOM.mainContent.style.display = 'block';
        showSetSelection();
    } else {
        DOM.mainContent.style.display = 'none';
        DOM.nameModal.style.display = 'flex';
        DOM.userNameInput.focus();
    }
}

function saveUserName() {
    const name = DOM.userNameInput.value.trim();
    if (!name) { alert('Please enter your name!'); return; }
    state.userName = name;
    localStorage.setItem(CONFIG.USER_NAME_STORAGE_KEY, state.userName);
    DOM.nameModal.style.display = 'none';
    DOM.mainContent.style.display = 'block';
    showSetSelection();
}

function showSetSelection() {
    showScreen(DOM.setSelectionScreen);
    fetchFlashcardData();
    fetchScreenTime();
}

function startFlashcardSession(selectedSet, setName) {
    if (!Array.isArray(selectedSet) || selectedSet.length === 0) {
        alert(`Error: Cannot start quiz for "${setName}" because the data is invalid.`);
        return;
    }
    Tone.start().catch(e => {});

    let fullSetCopy = [...selectedSet];
    shuffleArray(fullSetCopy);
    state.currentSetData = fullSetCopy.slice(0, Math.min(fullSetCopy.length, CONFIG.QUESTIONS_PER_SET));
    state.currentSetName = setName;
    state.currentQuestionIndex = 0;
    state.score = 0;
    state.incorrectAnswers = [];
    state.isRedoing = false;
    state.startTime = new Date();
    
    showScreen(DOM.flashcardScreen);
    renderFlashcardScreen();
}

function renderFlashcardScreen() {
    if (state.currentQuestionIndex >= state.currentSetData.length) {
        renderResultsScreen();
        return;
    }

    const questionData = state.currentSetData[state.currentQuestionIndex];
    const totalQuestions = state.currentSetData.length;
    const progressPercentage = totalQuestions > 0 ? (state.currentQuestionIndex / totalQuestions) * 100 : 0;
    
    DOM.flashcardScreen.innerHTML = `
        <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-slate-600">Progress</span>
                <span class="text-sm font-medium text-blue-700">${state.currentQuestionIndex} / ${totalQuestions}</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2.5">
                <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: ${progressPercentage}%"></div>
            </div>
        </div>
        <div id="flashcard" class="bg-white border border-slate-300 rounded-lg p-6 mb-6 text-center min-h-[200px] flex flex-col items-center justify-center transition-colors duration-300">
            <div class="w-full flex flex-col items-center justify-center">
                <div id="feedbackIcon" class="hidden text-7xl md:text-8xl mb-2"></div>
                <p id="questionText" class="text-lg md:text-xl font-semibold text-slate-800">${questionData.question}</p>
                <div id="feedbackText" class="mt-2 text-base md:text-lg font-semibold"></div>
                <p id="continueText" class="hidden mt-4 text-sm text-slate-500">Tap card to continue...</p>
            </div>
        </div>
        <div id="answerChoices" class="grid grid-cols-1 gap-3 md:gap-4">
            ${generateChoiceButtons(questionData.options, questionData.correctAnswer)}
        </div>
        <button onclick="showSetSelection()" class="action-button mt-6 bg-slate-500 hover:bg-slate-600 text-white w-full text-sm py-3 px-6 rounded-lg">Back to Set Selection</button>
    `;
}

function generateChoiceButtons(options, correctAnswer) {
    let shuffledOptions = [...options];
    shuffleArray(shuffledOptions);
    return shuffledOptions.map(option => `
        <button 
            class="choice-button action-button bg-slate-100 hover:bg-slate-200 text-slate-700 p-3 text-base md:text-lg rounded-lg min-h-[60px]"
            onclick="checkAnswer(this, \`${btoa(option)}\`, \`${btoa(correctAnswer)}\`)">
            ${option}
        </button>
    `).join('');
}

function checkAnswer(buttonEl, selectedAnswerB64, correctAnswerB64) {
    const selectedAnswer = atob(selectedAnswerB64);
    const correctAnswer = atob(correctAnswerB64);
    const questionData = state.currentSetData[state.currentQuestionIndex];
    
    document.querySelectorAll('.choice-button').forEach(btn => btn.disabled = true);

    const flashcardDiv = document.getElementById('flashcard');
    const questionTextDiv = document.getElementById('questionText');
    const feedbackIconDiv = document.getElementById('feedbackIcon');
    const feedbackTextDiv = document.getElementById('feedbackText');
    
    questionTextDiv.style.display = 'none';
    feedbackIconDiv.style.display = 'block';

    if (selectedAnswer === correctAnswer) {
        sounds.correct.triggerAttackRelease("G5", "8n");
        DOM.confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        if (!state.isRedoing) state.score++;

        flashcardDiv.className += ' bg-green-500 text-white';
        feedbackIconDiv.innerHTML = 'âœ“';
        feedbackTextDiv.textContent = 'Correct!';
        document.getElementById('continueText').style.display = 'block';
        
        flashcardDiv.onclick = proceedToNext;
        setTimeout(proceedToNext, CONFIG.AUTO_PROCEED_DELAY);

    } else {
        sounds.incorrect.triggerAttackRelease("C3", "8n");
        if (!state.isRedoing) state.incorrectAnswers.push({ questionData, userAnswer: selectedAnswer });

        flashcardDiv.className += ' bg-red-500 text-white animate-shake';
        setTimeout(() => flashcardDiv.classList.remove('animate-shake'), 500);

        feedbackIconDiv.innerHTML = 'âœ—';
        feedbackTextDiv.innerHTML = `
            <div>Correct Answer: <span class="font-bold">${correctAnswer}</span></div>
            <div class="explanation-box mt-2">${questionData.explanation || ''}</div>
            <div class="prompt-guidance mt-3">Click the correct answer below to continue.</div>
        `;

        document.querySelectorAll('.choice-button').forEach(btn => {
            if (btn.textContent.trim() === correctAnswer) {
                btn.className = 'choice-button action-button bg-green-500 hover:bg-green-600 text-white p-3 text-base md:text-lg rounded-lg min-h-[60px]';
                btn.disabled = false;
                btn.onclick = proceedToNext;
            } else {
                btn.classList.add('opacity-50');
            }
        });
    }
}

function proceedToNext() {
    state.currentQuestionIndex++;
    renderFlashcardScreen();
}

function renderResultsScreen() {
    const totalQuestions = state.currentSetData.length;
    const currentScore = state.isRedoing ? (totalQuestions - state.incorrectAnswers.length) : state.score;
    const percentage = totalQuestions > 0 ? Math.round((currentScore / totalQuestions) * 100) : 0;
    
    let awardText = '';
    if (!state.isRedoing && percentage > CONFIG.REWARD_THRESHOLD_PERCENT) {
        state.currentScreenTime += CONFIG.MINUTES_PER_REWARD;
        awardText = `<p class="text-xl text-green-600 font-bold mb-4">ðŸŽ‰ You earned ${CONFIG.MINUTES_PER_REWARD} minutes of screen time! ðŸŽ‰</p>`;
        sendDataToGoogle({ payloadType: 'awardScreenTime', name: state.userName, minutes: CONFIG.MINUTES_PER_REWARD });
        updateScreenTimeUI(state.currentScreenTime);
    }
    
    let encouragement = "Good job! Review the incorrect answers to strengthen your knowledge.";
    if (percentage === 100) encouragement = "Perfect score! You're a master!";
    else if (percentage >= 70) encouragement = "Excellent work! Your understanding is strong.";

    DOM.resultsScreen.innerHTML = `
        <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-4">${state.isRedoing ? 'Review Complete!' : `${state.currentSetName} Complete!`}</h2>
        <div class="bg-blue-500 text-white p-4 rounded-lg mb-6"><p class="text-lg font-semibold mb-1">Your Score:</p><p class="text-5xl font-bold italic">${currentScore} / ${totalQuestions}</p></div>
        <p class="text-lg text-slate-700 mb-2">Percentage: <span class="font-semibold">${percentage}</span>%</p>
        ${awardText}
        <p class="text-lg text-blue-700 font-semibold mb-6">${encouragement}</p>
        <div class="mb-6 text-left ${state.incorrectAnswers.length === 0 ? 'hidden' : ''}">
            <h3 class="text-xl font-semibold text-red-600 mb-3">Review Incorrect Answers:</h3>
            <ul class="list-disc list-inside space-y-2 text-slate-600">
                ${state.incorrectAnswers.map(item => `<li><b>Q:</b> ${item.questionData.question}<br/><b>Your:</b> <span class="text-red-500">${item.userAnswer}</span><br/><b>Correct:</b> <span class="text-green-600">${item.questionData.correctAnswer}</span></li>`).join('')}
            </ul>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="redoIncorrect()" class="action-button bg-orange-500 hover:bg-orange-600 text-white w-full py-3 px-6 rounded-lg ${state.incorrectAnswers.length === 0 || state.isRedoing ? 'hidden' : ''}">Redo Incorrect</button>
            <button onclick="showSetSelection()" class="action-button bg-blue-500 hover:bg-blue-600 text-white w-full py-3 px-6 rounded-lg">Choose Another Set</button>
        </div>
    `;

    if (!state.isRedoing) {
        sendDataToGoogle({ payloadType: 'flashcardResults', name: state.userName, setName: state.currentSetName, score: currentScore, totalQuestions, percentage, timeTaken: 0, incorrectAnswersJSON: JSON.stringify(state.incorrectAnswers.map(item => ({ q: item.questionData.question, u: item.userAnswer, c: item.questionData.correctAnswer }))) });
    }
    showScreen(DOM.resultsScreen);
}

function redoIncorrect() {
    if (state.incorrectAnswers.length === 0) return;
    state.currentSetData = state.incorrectAnswers.map(item => item.questionData);
    state.currentSetName = `${state.currentSetName} (Redo)`;
    state.currentQuestionIndex = 0;
    state.score = 0;
    state.incorrectAnswers = [];
    state.isRedoing = true;
    showScreen(DOM.flashcardScreen);
    renderFlashcardScreen();
}
</script>
</body>
</html>
